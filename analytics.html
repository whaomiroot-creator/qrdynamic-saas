<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - QRDynamic</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QRDynamic">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="EstatÃ­sticas e analytics dos seus QR Codes dinÃ¢micos">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-72x72.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* RESPONSIVO MOBILE */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem !important;
            }
            
            .grid-cols-4 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            canvas {
                max-height: 250px !important;
            }
        }

        @media (max-width: 640px) {
            .grid-cols-4 {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body class="min-h-screen text-gray-100">
    
    <header class="container mx-auto px-4 py-4 sm:py-6">
        <nav class="flex flex-wrap justify-between items-center gap-3">
            <div class="flex items-center space-x-2">
                <svg class="w-6 h-6 sm:w-8 sm:h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                </svg>
                <span class="text-lg sm:text-xl font-bold">QRDynamic</span>
            </div>
            <div class="flex flex-wrap items-center gap-2 sm:gap-3">
                <a href="create.html" class="bg-slate-700 hover:bg-slate-600 px-3 py-2 sm:px-4 rounded-lg transition-colors text-xs sm:text-sm font-medium">
                    âž• <span class="hidden sm:inline">Criar</span>
                </a>
                <a href="admin.html" class="bg-slate-700 hover:bg-slate-600 px-3 py-2 sm:px-4 rounded-lg transition-colors text-xs sm:text-sm font-medium">
                    ðŸ“‚ <span class="hidden sm:inline">Meus QR Codes</span><span class="sm:hidden">QR</span>
                </a>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-3 py-2 sm:px-4 rounded-lg transition-colors text-xs sm:text-sm font-medium">
                    ðŸšª <span class="hidden sm:inline">Sair</span>
                </button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-6 sm:py-12">
        <div class="max-w-7xl mx-auto">
            
            <div class="mb-6 sm:mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold mb-2">ðŸ“Š Analytics</h1>
                <p class="text-sm sm:text-base text-gray-400">EstatÃ­sticas detalhadas dos seus QR Codes</p>
            </div>

            <!-- Filtro de QR Code -->
            <div class="mb-6">
                <label class="block text-sm font-medium mb-2">Selecione o QR Code</label>
                <select id="qr-select" onchange="loadAnalytics()" class="w-full md:w-96 px-3 sm:px-4 py-2.5 sm:py-3 bg-slate-800 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-white text-sm sm:text-base">
                    <option value="">Carregando...</option>
                </select>
            </div>

            <!-- Cards de EstatÃ­sticas -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
                <div class="bg-slate-800/50 rounded-xl p-4 sm:p-6 border border-slate-700">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-500/20 p-2 sm:p-3 rounded-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-gray-400 text-xs sm:text-sm">Total de Cliques</p>
                            <p class="text-2xl sm:text-3xl font-bold" id="total-clicks">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/50 rounded-xl p-4 sm:p-6 border border-slate-700">
                    <div class="flex items-center gap-3">
                        <div class="bg-green-500/20 p-2 sm:p-3 rounded-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-gray-400 text-xs sm:text-sm">Ãšltimos 7 Dias</p>
                            <p class="text-2xl sm:text-3xl font-bold" id="last-7-days">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/50 rounded-xl p-4 sm:p-6 border border-slate-700">
                    <div class="flex items-center gap-3">
                        <div class="bg-purple-500/20 p-2 sm:p-3 rounded-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-gray-400 text-xs sm:text-sm">Mobile</p>
                            <p class="text-2xl sm:text-3xl font-bold" id="mobile-clicks">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/50 rounded-xl p-4 sm:p-6 border border-slate-700">
                    <div class="flex items-center gap-3">
                        <div class="bg-orange-500/20 p-2 sm:p-3 rounded-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-gray-400 text-xs sm:text-sm">Desktop</p>
                            <p class="text-2xl sm:text-3xl font-bold" id="desktop-clicks">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GrÃ¡fico -->
            <div class="bg-slate-800/50 rounded-xl p-4 sm:p-6 border border-slate-700 mb-6 sm:mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <h2 class="text-lg sm:text-xl font-bold">Cliques ao Longo do Tempo</h2>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button onclick="changeFilter('7')" id="btn-7" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-blue-600 rounded-lg text-xs sm:text-sm font-medium">7 dias</button>
                        <button onclick="changeFilter('30')" id="btn-30" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-slate-700 rounded-lg text-xs sm:text-sm font-medium">30 dias</button>
                        <button onclick="changeFilter('all')" id="btn-all" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-slate-700 rounded-lg text-xs sm:text-sm font-medium">Tudo</button>
                    </div>
                </div>
                <canvas id="clicks-chart" height="100"></canvas>
            </div>

            <!-- Tabela de Ãšltimos Cliques -->
            <div class="bg-slate-800/50 rounded-xl p-4 sm:p-6 border border-slate-700">
                <h2 class="text-lg sm:text-xl font-bold mb-4">Ãšltimos Cliques</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="border-b border-slate-700">
                            <tr>
                                <th class="pb-3 text-gray-400 font-medium text-xs sm:text-sm">Data/Hora</th>
                                <th class="pb-3 text-gray-400 font-medium text-xs sm:text-sm">Dispositivo</th>
                                <th class="pb-3 text-gray-400 font-medium text-xs sm:text-sm hidden sm:table-cell">Origem</th>
                            </tr>
                        </thead>
                        <tbody id="recent-clicks">
                            <tr><td colspan="3" class="py-4 text-gray-400 text-center text-xs sm:text-sm">Selecione um QR Code</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <script>
        const supabase = window.supabase.createClient(
            'https://ysyarhpqpslfehzcrtom.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzeWFyaHBxcHNsZmVoemNydG9tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMTg2NDcsImV4cCI6MjA4Mjc5NDY0N30.A2eXYvLaOPVszW2jsAy5OzPOYt6gQF2iUp8XSjyljPM'
        );

        let currentUserEmail = null;
        let currentSlug = null;
        let currentFilter = '7';
        let chart = null;

        // Verificar login
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                window.location.href = 'index.html';
            } else {
                currentUserEmail = session.user.email;
                loadQRCodes();
            }
        });

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        async function loadQRCodes() {
            const { data, error } = await supabase
                .from('qr_links')
                .select('slug, link_name')
                .eq('user_email', currentUserEmail)
                .order('created_at', { ascending: false });

            if (error || !data || data.length === 0) {
                document.getElementById('qr-select').innerHTML = '<option value="">Nenhum QR Code encontrado</option>';
                return;
            }

            const select = document.getElementById('qr-select');
            select.innerHTML = data.map(qr => 
                `<option value="${qr.slug}">${qr.link_name}</option>`
            ).join('');

            currentSlug = data[0].slug;
            loadAnalytics();
        }

        async function loadAnalytics() {
            const select = document.getElementById('qr-select');
            currentSlug = select.value;

            if (!currentSlug) return;

            // Calcular perÃ­odo
            let dateFilter = null;
            if (currentFilter === '7') {
                dateFilter = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
            } else if (currentFilter === '30') {
                dateFilter = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
            }

            // Buscar todos os cliques
            let query = supabase
                .from('click_logs')
                .select('*')
                .eq('slug', currentSlug)
                .order('clicked_at', { ascending: false });

            if (dateFilter) {
                query = query.gte('clicked_at', dateFilter);
            }

            const { data: clicks, error } = await query;

            if (error) {
                console.error('Erro:', error);
                return;
            }

            updateStats(clicks);
            updateChart(clicks);
            updateRecentTable(clicks);
        }

        function updateStats(clicks) {
            const total = clicks.length;
            const last7Days = clicks.filter(c => 
                new Date(c.clicked_at) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
            ).length;
            const mobile = clicks.filter(c => c.device === 'mobile').length;
            const desktop = clicks.filter(c => c.device === 'desktop').length;

            document.getElementById('total-clicks').textContent = total;
            document.getElementById('last-7-days').textContent = last7Days;
            document.getElementById('mobile-clicks').textContent = mobile;
            document.getElementById('desktop-clicks').textContent = desktop;
        }

        function updateChart(clicks) {
            // Agrupar por dia
            const clicksByDate = {};
            clicks.forEach(click => {
                const date = new Date(click.clicked_at).toLocaleDateString('pt-BR');
                clicksByDate[date] = (clicksByDate[date] || 0) + 1;
            });

            const labels = Object.keys(clicksByDate).reverse();
            const data = Object.values(clicksByDate).reverse();

            if (chart) chart.destroy();

            const ctx = document.getElementById('clicks-chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cliques',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8', stepSize: 1 },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function updateRecentTable(clicks) {
            const tbody = document.getElementById('recent-clicks');
            
            if (clicks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="py-4 text-gray-400 text-center">Nenhum clique ainda</td></tr>';
                return;
            }

            const isMobile = window.innerWidth < 640;

            tbody.innerHTML = clicks.slice(0, 10).map(click => {
                const date = new Date(click.clicked_at);
                const formatted = isMobile 
                    ? date.toLocaleDateString('pt-BR') 
                    : date.toLocaleString('pt-BR');
                const device = click.device === 'mobile' ? 'ðŸ“± Mobile' : 'ðŸ’» Desktop';
                const referrer = click.referrer === 'direct' ? 'Direto' : click.referrer;

                return `
                    <tr class="border-b border-slate-700">
                        <td class="py-3 text-xs sm:text-sm">${formatted}</td>
                        <td class="py-3 text-xs sm:text-sm">${device}</td>
                        <td class="py-3 text-xs sm:text-sm text-gray-400 hidden sm:table-cell">${referrer}</td>
                    </tr>
                `;
            }).join('');
        }

        function changeFilter(filter) {
            currentFilter = filter;
            
            // Atualizar botÃµes
            ['7', '30', 'all'].forEach(f => {
                const btn = document.getElementById(`btn-${f}`);
                if (f === filter) {
                    btn.classList.remove('bg-slate-700');
                    btn.classList.add('bg-blue-600');
                } else {
                    btn.classList.remove('bg-blue-600');
                    btn.classList.add('bg-slate-700');
                }
            });

            loadAnalytics();
        }
    </script>

    <!-- PWA Install Script -->
    <script>
    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('âœ… Service Worker registrado!', registration.scope);
                })
                .catch(error => {
                    console.error('âŒ Erro ao registrar Service Worker:', error);
                });
        });
    }

    // Popup de InstalaÃ§Ã£o
    let deferredPrompt;
    const installButton = document.createElement('button');
    installButton.innerHTML = 'ðŸ“± Instalar App';
    installButton.className = 'fixed bottom-4 right-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full shadow-lg font-semibold transition-all z-50 hidden animate-bounce';
    installButton.id = 'install-button';
    document.body.appendChild(installButton);

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Mostrar botÃ£o de instalaÃ§Ã£o
        installButton.classList.remove('hidden');
    });

    installButton.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
            console.log('âœ… App instalado!');
        }
        
        deferredPrompt = null;
        installButton.classList.add('hidden');
    });

    // Detectar se jÃ¡ estÃ¡ instalado
    window.addEventListener('appinstalled', () => {
        console.log('âœ… QRDynamic instalado com sucesso!');
        installButton.classList.add('hidden');
    });

    // Verificar se jÃ¡ estÃ¡ rodando como PWA
    if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('âœ… Rodando como PWA!');
        installButton.classList.add('hidden');
    }
    </script>

</body>
</html>
